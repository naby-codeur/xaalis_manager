// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum UserRole {
  ADMIN         // Administrateur
  TREASURER      // Trésorier
  PROJECT_MANAGER // Responsable projet
  AUDITOR        // Auditeur
  MEMBER         // Membre
}

enum TransactionType {
  EXPENSE  // Dépense
  INCOME   // Entrée/Ressource
}

enum ExpenseCategory {
  TRANSPORT
  SALARIES
  EQUIPMENT
  SUPPLIES
  COMMUNICATION
  TRAINING
  ADMINISTRATIVE
  OTHER
}

enum IncomeSource {
  GRANT          // Subvention
  DONATION       // Don
  CONTRIBUTION   // Cotisation
  PARTNERSHIP    // Partenariat
  SALE           // Vente
  OTHER
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  SUSPENDED
  PLANNED
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String
  lastName  String
  role      UserRole @default(MEMBER)
  avatar    String?
  isActive  Boolean  @default(true)
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  transactions     Transaction[]
  auditLogs        AuditLog[]
  notifications    Notification[]
  
  @@map("users")
}

model Organization {
  id          String @id @default(cuid())
  name        String
  description String?
  logo        String?
  website     String?
  address     String?
  phone       String?
  email       String?
  
  // Settings
  currency    String @default("XOF")
  timezone    String @default("Africa/Dakar")
  language    String @default("fr")
  
  // Relations
  users         User[]
  projects      Project[]
  cashAccounts  CashAccount[]
  budgets       Budget[]
  categories    Category[]
  invitations   Invitation[]
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("organizations")
}

// Invitations management
model Invitation {
  id              String   @id @default(cuid())
  email           String
  role            UserRole
  organizationId  String
  token           String   @unique
  expiresAt       DateTime
  acceptedAt      DateTime?
  invitedByUserId String
  status          String   @default("PENDING") // PENDING | ACCEPTED | REVOKED | EXPIRED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invitations")
}

// Project Management
model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  startDate   DateTime?
  endDate     DateTime?
  budget      Decimal       @default(0)
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Relations
  transactions   Transaction[]
  cashAccounts   CashAccount[]
  budgets        Budget[]
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("projects")
}

// Cash Management
model CashAccount {
  id          String @id @default(cuid())
  name        String
  description String?
  balance     Decimal @default(0)
  currency    String  @default("XOF")
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Relations
  transactions Transaction[]
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("cash_accounts")
}

// Transaction Management
model Transaction {
  id          String          @id @default(cuid())
  amount      Decimal
  type        TransactionType
  description String
  reference   String?         // Numéro de référence
  date        DateTime        @default(now())
  
  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  cashAccountId String
  cashAccount   CashAccount @relation(fields: [cashAccountId], references: [id], onDelete: Cascade)
  
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Attachments
  attachments Attachment[]
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("transactions")
}

// Categories
model Category {
  id          String @id @default(cuid())
  name        String
  description String?
  type        TransactionType
  color       String? // Couleur pour l'UI
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Relations
  transactions Transaction[]
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("categories")
}

// Budget Management
model Budget {
  id          String @id @default(cuid())
  name        String
  amount      Decimal
  spent       Decimal @default(0)
  period      String  // monthly, quarterly, yearly
  startDate   DateTime
  endDate     DateTime
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("budgets")
}

// File Attachments
model Attachment {
  id          String @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  description String?
  
  // Relations
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt DateTime @default(now())
  
  @@map("attachments")
}

// Audit Logging
model AuditLog {
  id        String @id @default(cuid())
  action    String // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity    String // User, Transaction, etc.
  entityId  String?
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  
  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt DateTime @default(now())
  
  @@map("audit_logs")
}

// Notifications
model Notification {
  id        String @id @default(cuid())
  title     String
  message   String
  type      String // info, warning, error, success
  isRead    Boolean @default(false)
  data      Json?   // Additional data
  
  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt DateTime @default(now())
  
  @@map("notifications")
}

// AI Analysis Results
model AIAnalysis {
  id          String @id @default(cuid())
  type        String // prediction, anomaly, recommendation
  title       String
  description String
  confidence  Float  // 0-1
  data        Json   // Analysis data
  isActive    Boolean @default(true)
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("ai_analyses")
}

// Add missing relation to Organization
model Organization {
  // ... existing fields ...
  aiAnalyses AIAnalysis[]
}